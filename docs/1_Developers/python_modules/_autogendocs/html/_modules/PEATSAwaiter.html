
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PEATSAwaiter &#8212; EMTG python  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for PEATSAwaiter</h1><div class="highlight"><pre>
<span></span><span class="c1">#EMTG: Evolutionary Mission Trajectory Generator</span>
<span class="c1">#An open-source global optimization tool for preliminary mission design</span>
<span class="c1">#Provided by NASA Goddard Space Flight Center</span>
<span class="c1">#</span>
<span class="c1">#Copyright (c) 2014 - 2024 United States Government as represented by the</span>
<span class="c1">#Administrator of the National Aeronautics and Space Administration.</span>
<span class="c1">#All Other Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1">#Licensed under the NASA Open Source License (the &quot;License&quot;); </span>
<span class="c1">#You may not use this file except in compliance with the License. </span>
<span class="c1">#You may obtain a copy of the License at:</span>
<span class="c1">#https://opensource.org/license/nasa1-3-php</span>
<span class="c1">#Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either </span>
<span class="c1">#express or implied.   See the License for the specific language</span>
<span class="c1">#governing permissions and limitations under the License.</span>

<span class="c1">#PEATSAwaiter class</span>
<span class="c1">#script to analyze the PEATSAboxes (determine if they need to go back in the oven) and </span>
<span class="c1">#if so, finds them a new initial guess</span>
<span class="c1">#Used to be step 4</span>
<span class="c1">#Jeremy Knittel 1-24-2018</span>

<div class="viewcode-block" id="PEATSAwaiter"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter">[docs]</a><span class="k">class</span> <span class="nc">PEATSAwaiter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="PEATSAwaiter.propulate"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.propulate">[docs]</a>    <span class="k">def</span> <span class="nf">propulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">all_boxes</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG/SimpleMonteCarlo/&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">maneuverExecutionError</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        
        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thin_crust</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Propulator code not set to work with thin crust peatsas yet. Sorry.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create a list to hold the cases 2 run</span>
        <span class="n">boxes_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">propulated_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">box1ups</span> <span class="o">=</span> <span class="p">[]</span>       
        <span class="n">total_time_to_propagate</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="n">duty_cycles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">propagated_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">og_journeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unit_thrust_dir</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">prop_in_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationIn0.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#JD, journey, duty cycle, step size [sec], x [km/s], y [km/s], z [km/s], xdot [km/s], ydot [km/s], zdot [km/s], mass [kg], [thrust_x, thrust_y, thrust_z,] propagation time [sec]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
        <span class="c1"># Loop through all of the samples</span>
        <span class="k">for</span> <span class="n">nSample</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nSamples</span><span class="p">):</span>
            
            <span class="c1"># Get all of the cases that have this index</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">all_boxes</span> <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloSampleIndex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nSample</span><span class="p">]</span>
            
            <span class="c1"># Sort the cases by their depth into the mission</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">box</span><span class="p">:</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">])</span>
            
            <span class="c1"># Initialize an index to double check we dont have duplicates</span>
            <span class="n">last_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="c1"># Loop through each box with the relevant index</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                
                <span class="c1"># Make sure that this box doesnt have the same index as the previous</span>
                <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_index</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Multiple versions of sample index: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nSample</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_index</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]</span>
                
                <span class="c1"># Check what the peatsa objective type is</span>
                <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">objective_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                    <span class="c1"># The peatsa objective type is simply to have an objective</span>
                    <span class="c1"># function value greater than the target objective value</span>
                
                    <span class="c1"># Check if the objective value is greater or not</span>
                    <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">&lt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">peatsa_goal_objective</span><span class="p">:</span>
                        <span class="c1"># It is less, so we need to add it to the outgoing boxes</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Needs to be re-run: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">objective_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                    <span class="c1"># The peatsa objective type is simply to have an objective</span>
                    <span class="c1"># function value less than the target objective value</span>
                
                    <span class="c1"># Check if the objective value is greater or not</span>
                    <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">peatsa_goal_objective</span><span class="p">:</span>
                        <span class="c1"># It is greater, so we need to add it to the outgoing boxes</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Needs to be re-run: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>      
                        <span class="k">continue</span>  
                
                <span class="c1"># If we are here, then this case needs to be re-run</span>
                
                <span class="c1"># Check if we need to propulate it&#39;s initial conditions</span>
                <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;InitialConditionsSet&quot;</span><span class="p">]:</span>
                    <span class="c1"># We dont</span>
                    <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                
                    <span class="c1"># First we need to find the case that has the burn that error will be applied to</span>
                    <span class="n">box2up</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">box2</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">box2</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We&#39;ve gone too far.&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">box2</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]:</span>
                            <span class="n">box2up</span> <span class="o">=</span> <span class="n">box2</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">box2up</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Box2Up not found&quot;</span><span class="p">)</span>
                    
                    
                    <span class="c1"># Second we need to find the case that has the control that will be simply propagated</span>
                    <span class="n">box1up</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">box1</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">box1</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We&#39;ve gone too far.&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">box1</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloDepthIndex&quot;</span><span class="p">]:</span>
                            <span class="n">box1up</span> <span class="o">=</span> <span class="n">box1</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">box1up</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Box1Up not found&quot;</span><span class="p">)</span>

                    
                    <span class="n">nominal_thrust</span> <span class="o">=</span> <span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Thrust</span>
                    <span class="n">summation</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">nominal_thrust</span><span class="p">:</span>
                        <span class="n">summation</span> <span class="o">+=</span> <span class="n">entry</span> <span class="o">*</span> <span class="n">entry</span>
                    <span class="kn">import</span> <span class="nn">math</span>
                    <span class="n">norm_thrust</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">summation</span><span class="p">)</span>
                    <span class="n">unit_thrust</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">nominal_thrust</span><span class="p">:</span>
                         <span class="n">unit_thrust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span> <span class="o">/</span> <span class="n">norm_thrust</span><span class="p">)</span>
                    
                    <span class="n">control_with_error_obj</span> <span class="o">=</span> <span class="n">maneuverExecutionError</span><span class="o">.</span><span class="n">maneuverExecutionError</span><span class="p">(</span><span class="n">unit_thrust</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thrusting_standard_deviations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.0</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thrusting_standard_deviations</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.0</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thrusting_standard_deviations</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                    <span class="c1"># Write the input propulator file    </span>
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">launch_window_open_date</span> <span class="o">+</span> <span class="mf">2400000.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">duty_cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">override_duty_cycle</span><span class="p">:</span>
                            <span class="n">duty_cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">duty_cycle</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">duty_cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">engine_duty_cycle</span><span class="p">)</span>
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>       
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;86400,&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;InitialStateWithAllErrors&quot;</span><span class="p">]:</span>
                        <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">control_with_error_obj</span><span class="o">.</span><span class="n">uRandomInertial</span><span class="p">:</span>
                        <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mf">86400.0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                    <span class="n">propulated_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">box1ups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box1up</span><span class="p">)</span>
                    <span class="n">total_time_to_propagate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">TimestepLength</span><span class="o">*</span><span class="mf">86400.0</span><span class="o">/</span><span class="n">duty_cycles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">propagated_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">86400.0</span><span class="p">)</span>
                    <span class="n">og_journeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box2up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">])</span>
                    <span class="n">unit_thrust_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_thrust</span><span class="p">)</span>
                
                <span class="c1"># Now we need to break, because we dont want to go any deeper into the monte carlo until the current case is complete</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box1ups</span><span class="p">):</span> 
            
            <span class="n">max_time_to_propagate</span> <span class="o">=</span> <span class="mf">86400.0</span>

            <span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">notdone</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="n">lastbox1ups</span> <span class="o">=</span> <span class="n">box1ups</span>

            <span class="k">while</span> <span class="n">notdone</span><span class="p">:</span>

                <span class="n">prop_in_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># Run the propulator</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulatorDriver&quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">reference_files_location</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">reference_options_file_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationIn&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationOut&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv &gt; /dev/null</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                
                <span class="kn">import</span> <span class="nn">time</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>
                  
                <span class="n">prop_out_file_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationOut&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                
                <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">line_start</span> <span class="o">=</span> <span class="mi">0</span>            
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">prop_out_file_lines</span><span class="p">:</span>
                    <span class="n">line_start</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JD&quot;</span><span class="p">):</span>
                        <span class="k">break</span>
                
                <span class="n">notdone</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="n">newbox1ups</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="n">prop_in_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationIn&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#JD, journey, duty cycle, step size [sec], x [km/s], y [km/s], z [km/s], xdot [km/s], ydot [km/s], zdot [km/s], mass [kg], [thrust_x, thrust_y, thrust_z,] propagation time [sec]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">box1up</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lastbox1ups</span><span class="p">):</span>
                    
                    <span class="n">linesplit</span> <span class="o">=</span> <span class="n">prop_out_file_lines</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">line_start</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">out_state</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">state_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                        <span class="n">out_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="n">state_idx</span><span class="p">]))</span>
            
                    <span class="k">if</span> <span class="n">total_time_to_propagate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">propagated_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_time_to_propagate</span><span class="p">:</span>
                        <span class="n">time_to_propagate</span> <span class="o">=</span> <span class="n">max_time_to_propagate</span>
                    <span class="k">elif</span> <span class="n">total_time_to_propagate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">propagated_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="p">:</span>
                        <span class="n">time_to_propagate</span> <span class="o">=</span> <span class="n">total_time_to_propagate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">propagated_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;InitialStateWithAllErrors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_state</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">write_options_file</span><span class="p">(</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSApath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough_path</span><span class="p">)</span>
                        <span class="k">continue</span>
                    
                    <span class="n">notdone</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="n">coast_time</span> <span class="o">=</span> <span class="n">total_time_to_propagate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">duty_cycles</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">coast_start</span> <span class="o">=</span> <span class="n">total_time_to_propagate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">coast_time</span>

                    <span class="k">if</span> <span class="n">propagated_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">time_to_propagate</span> <span class="o">&lt;</span> <span class="n">coast_start</span><span class="p">:</span>
                        <span class="n">duty_cycle</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">elif</span> <span class="n">propagated_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">coast_start</span><span class="p">:</span>
                        <span class="n">duty_cycle</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">duty_cycle</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="n">time_to_propagate</span> <span class="o">=</span> <span class="n">coast_start</span> <span class="o">-</span> <span class="n">propagated_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>       
                                 
                    <span class="n">control_with_error_obj</span> <span class="o">=</span> <span class="n">maneuverExecutionError</span><span class="o">.</span><span class="n">maneuverExecutionError</span><span class="p">(</span><span class="n">unit_thrust_dir</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thrusting_standard_deviations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.0</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thrusting_standard_deviations</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.0</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thrusting_standard_deviations</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">og_journeys</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>       
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;86400,&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">out_state</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">control_with_error_obj</span><span class="o">.</span><span class="n">uRandomInertial</span><span class="p">:</span>
                        <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">prop_in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time_to_propagate</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">propagated_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">time_to_propagate</span>
                    <span class="n">newbox1ups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box1up</span><span class="p">)</span>
                <span class="n">lastbox1ups</span> <span class="o">=</span> <span class="n">newbox1ups</span>
                
            <span class="n">prop_in_file_final</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationInFinal.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#JD, journey, duty cycle, step size [sec], x [km/s], y [km/s], z [km/s], xdot [km/s], ydot [km/s], zdot [km/s], mass [kg], [thrust_x, thrust_y, thrust_z,] propagation time [sec]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">box1up</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">box1ups</span><span class="p">):</span>      
                
                <span class="n">nominal_thrust</span> <span class="o">=</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Thrust</span>
                <span class="n">summation</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">nominal_thrust</span><span class="p">:</span>
                    <span class="n">summation</span> <span class="o">+=</span> <span class="n">entry</span> <span class="o">*</span> <span class="n">entry</span>
                <span class="kn">import</span> <span class="nn">math</span>
                <span class="n">norm_thrust</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">summation</span><span class="p">)</span>
                <span class="n">unit_thrust</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">nominal_thrust</span><span class="p">:</span>
                     <span class="n">unit_thrust</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span> <span class="o">/</span> <span class="n">norm_thrust</span><span class="p">)</span>
        
                <span class="c1"># Write the input propulator file    </span>
                <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">launch_window_open_date</span> <span class="o">+</span> <span class="mf">2400000.5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">override_duty_cycle</span><span class="p">:</span>
                        <span class="n">dc</span> <span class="o">=</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">duty_cycle</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dc</span> <span class="o">=</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">engine_duty_cycle</span> 
                <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0,&quot;</span><span class="p">)</span>
                <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;86400,&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;InitialStateWithAllErrors&quot;</span><span class="p">]:</span>
                    <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">unit_thrust</span><span class="p">:</span>
                    <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">TimestepLength</span><span class="o">*</span><span class="mf">86400.0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">prop_in_file_final</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
         
            <span class="c1"># Run the propulator</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulatorDriver&quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">reference_files_location</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">reference_options_file_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationInFinal.csv &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationOutFinal.csv &gt; /dev/null</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            
            <span class="n">prop_in_file_final2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationInFinal2.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#JD, journey, duty cycle, step size [sec], x [km/s], y [km/s], z [km/s], xdot [km/s], ydot [km/s], zdot [km/s], mass [kg], [thrust_x, thrust_y, thrust_z,] propagation time [sec]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">prop_out_file_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationOutFinal.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                                           
            <span class="n">line_start</span> <span class="o">=</span> <span class="mi">0</span>            
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">prop_out_file_lines</span><span class="p">:</span>
                <span class="n">line_start</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JD&quot;</span><span class="p">):</span>
                    <span class="k">break</span>
                    
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">box1up</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">box1ups</span><span class="p">):</span>      
                
                <span class="n">linesplit</span> <span class="o">=</span> <span class="n">prop_out_file_lines</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">line_start</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
             
                <span class="n">out_state</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">state_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
                    <span class="n">out_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">state_idx</span><span class="p">]))</span>
                        
                <span class="c1"># Write the input propulator file    </span>
                <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">dc</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">override_duty_cycle</span><span class="p">:</span>
                        <span class="n">dc</span> <span class="o">=</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">duty_cycle</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dc</span> <span class="o">=</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">engine_duty_cycle</span> 
                <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0.0,&quot;</span><span class="p">)</span>
                <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;86400,&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">out_state</span><span class="p">:</span>
                    <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0.0,0.0,0.0,&quot;</span><span class="p">)</span>
                <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">TimestepLength</span><span class="o">*</span><span class="mf">86400.0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">dc</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">prop_in_file_final2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
         
            <span class="c1"># Run the propulator</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulatorDriver&quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">reference_files_location</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">reference_options_file_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationInFinal2.csv &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationOutFinal2.csv &gt; /dev/null</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    
            <span class="n">prop_out_file_lines2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="s2">&quot;/PropulationOutFinal2.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                                           
            <span class="n">line_start</span> <span class="o">=</span> <span class="mi">0</span>            
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">prop_out_file_lines2</span><span class="p">:</span>
                <span class="n">line_start</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JD&quot;</span><span class="p">):</span>
                    <span class="k">break</span>
                            
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">propulated_boxes</span><span class="p">):</span>
                <span class="n">box1up</span> <span class="o">=</span> <span class="n">box1ups</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            
                <span class="n">linesplit</span> <span class="o">=</span> <span class="n">prop_out_file_lines2</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="n">line_start</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
             
                <span class="n">out_state</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">state_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
                    <span class="n">out_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">linesplit</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">state_idx</span><span class="p">]))</span>
                <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">departure_elements</span> <span class="o">=</span> <span class="n">out_state</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">maximum_mass</span> <span class="o">=</span> <span class="n">out_state</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;InitialConditionsSet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            
                <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span> <span class="o">=</span> <span class="p">[]</span>
            
                <span class="n">add_all</span> <span class="o">=</span> <span class="kc">False</span>
            
                <span class="n">virtual_ep_ctr</span> <span class="o">=</span> <span class="mi">0</span>         
                              
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">):</span>
                    <span class="n">descrip</span> <span class="o">=</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">Xdescriptions</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                
                    <span class="n">jdx2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">descrip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;j&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">jdx2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">]:</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jdx2</span><span class="p">)</span> <span class="o">+</span> <span class="n">descrip</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;j0123456789&quot;</span><span class="p">),</span><span class="n">entry</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Havent figured out how to do this yet&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">jdx2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;MonteCarloOriginalJourney&quot;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Havent figured out how to do this yet&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;phase flight time&quot;</span> <span class="ow">in</span> <span class="n">descrip</span><span class="p">:</span>
                            <span class="n">add_all</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state x&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">departure_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state y&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">departure_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state z&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">departure_elements</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state xdot&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">departure_elements</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state ydot&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">departure_elements</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state zdot&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">departure_elements</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                            <span class="c1"># Add the mass</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state mass&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">maximum_mass</span><span class="p">])</span>
                            <span class="c1"># Add the epoch</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFBFreePointFreeDirectDeparture: event left state epoch&quot;</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">launch_window_open_date</span><span class="p">])</span>
                            <span class="c1"># Add the flight time                                            </span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFB: phase flight time&quot;</span><span class="p">,</span><span class="n">box1up</span><span class="o">.</span><span class="n">PEATSAcrust</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">JulianDate</span><span class="o">-</span><span class="mf">2400000.5</span><span class="o">-</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">launch_window_open_date</span><span class="p">])</span>
                                           
                        <span class="k">elif</span> <span class="s2">&quot;PSFB: virtual chemical&quot;</span> <span class="ow">in</span> <span class="n">descrip</span> <span class="ow">and</span> <span class="s1">&#39;Step&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">descrip</span><span class="p">:</span>
                            <span class="n">add_all</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="c1"># Add the chem propellant</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFB: virtual chemical fuel&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="s2">&quot;PSFB: virtual electric&quot;</span> <span class="ow">in</span> <span class="n">descrip</span> <span class="ow">and</span> <span class="s1">&#39;Step&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">descrip</span><span class="p">:</span>
                            <span class="c1"># Add the ep propellant</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFB: virtual electric propellant&quot;</span><span class="p">,</span><span class="n">entry</span><span class="p">])</span>
                            <span class="n">virtual_ep_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">add_all</span><span class="p">:</span>
                            <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0&quot;</span> <span class="o">+</span> <span class="n">descrip</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;j0123456789&quot;</span><span class="p">),</span><span class="n">entry</span><span class="p">])</span>                                       
                        <span class="k">elif</span> <span class="s2">&quot;Step&quot;</span> <span class="ow">in</span> <span class="n">descrip</span><span class="p">:</span>
                            <span class="n">step2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">descrip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_Step&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">step2</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;j0p0PSFB_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">step2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">descrip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">entry</span><span class="p">])</span>
                                <span class="k">if</span> <span class="s2">&quot;virtual electric&quot;</span> <span class="ow">in</span> <span class="n">descrip</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">step2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">virtual_ep_ctr</span> <span class="o">=</span> <span class="n">entry</span> 
                                        <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">virtual_ep_ctr</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">virtual_ep_ctr</span>    
                    
                <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">[</span><span class="n">virtual_ep_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">virtual_ep_ctr</span>
                
                <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ManeuverConstraintDefinitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;p0b0_dutycycle_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_propulated_duty_cycle</span><span class="p">))</span>
                    <span class="n">MO</span><span class="o">.</span><span class="n">AssembleMasterConstraintVectors</span><span class="p">()</span>
                
                <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">boxes_out</span><span class="p">,</span> <span class="n">all_boxes</span></div>

<div class="viewcode-block" id="PEATSAwaiter.check_only_run_if"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.check_only_run_if">[docs]</a>    <span class="k">def</span> <span class="nf">check_only_run_if</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAboxes_in</span><span class="p">,</span><span class="n">override</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>                
        <span class="c1"># Check if non-optimality criteria is being applied to determine if cases</span>
        <span class="c1"># should be re-run</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">only_rerun_if</span><span class="p">):</span>
        
            <span class="c1"># Initialize the list of peatsa boxes (cases) that need to be re-run</span>
            <span class="n">boxes_out</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Loop through all of the cases</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">PEATSAboxes_in</span><span class="p">:</span>
            
                <span class="c1"># Assume we will not re-run it</span>
                <span class="n">re_run</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Grab the mission object so that it can be used in evaluation</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span><span class="s2">&quot;PEATSAcrust&quot;</span><span class="p">):</span>
                    <span class="n">M</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAcrust</span>
            
                <span class="n">MO</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span>
            
                <span class="c1"># Loop through all criteria.</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">only_rerun_if</span><span class="p">:</span>
                                                    
                    <span class="c1"># Check condition</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
                            <span class="c1"># It evaluated true, change the flag</span>
                            <span class="n">re_run</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># Condition cant be evaluated, so just re-run</span>
                        <span class="n">re_run</span> <span class="o">=</span> <span class="kc">True</span>
            
                <span class="c1"># If nothing has overriden the re-run = false condition, then go to the next box</span>
                <span class="k">if</span> <span class="n">re_run</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAboxes_in</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">boxes_out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re_run</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>      
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAboxes_in</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">override</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PEATSAboxes_in</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>     </div>
    
<div class="viewcode-block" id="PEATSAwaiter.check_optimality"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.check_optimality">[docs]</a>    <span class="k">def</span> <span class="nf">check_optimality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAboxes_in</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking which cases are complete&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize the list of peatsa boxes (cases) that need to be re-run</span>
        <span class="n">boxes_out</span> <span class="o">=</span> <span class="p">[]</span>
                
        <span class="c1"># Loop through all of the cases</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">PEATSAboxes_in</span><span class="p">:</span>
        
            <span class="n">re_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_only_run_if</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,[</span><span class="n">box</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">re_run</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check what the peatsa objective type is</span>
            <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">objective_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                <span class="c1"># The peatsa objective type is simply to have an objective</span>
                <span class="c1"># function value greater than the target objective value</span>
                
                <span class="c1"># Check if the objective value is greater or not</span>
                <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">&lt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">peatsa_goal_objective</span><span class="p">:</span>
                    <span class="c1"># It is less, so we need to add it to the outgoing boxes</span>
                    <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Needs to be re-run: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">objective_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                <span class="c1"># The peatsa objective type is simply to have an objective</span>
                <span class="c1"># function value less than the target objective value</span>
                
                <span class="c1"># Check if the objective value is greater or not</span>
                <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">peatsa_goal_objective</span><span class="p">:</span>
                    <span class="c1"># It is greater, so we need to add it to the outgoing boxes</span>
                    <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Needs to be re-run: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">objective_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># We need to make a polynomial fit of the seed cases and then</span>
                <span class="c1"># check how well the current case does by comparison</span>
                
                <span class="c1"># First, find the seed cases</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_seed_cases</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">PEATSAboxes_in</span><span class="p">)</span>
                
                <span class="c1"># Assume it needs to be re-run</span>
                <span class="n">needs_to_be_rerun</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># Loop through the different seed criteria</span>
                <span class="k">for</span> <span class="n">seed_criteria</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">:</span>
                    
                    <span class="c1"># Check if there are enough cases to satisfy the </span>
                    <span class="c1"># needs of the polynomial order requested</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">polyfit_order</span><span class="p">:</span>
                    
                        <span class="c1"># Polyfit is a member of numpy, so import it</span>
                        <span class="kn">import</span> <span class="nn">numpy</span>
                    
                        <span class="c1"># Get the arrays of data that make the polyfit</span>
                        <span class="n">xData</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
                        <span class="n">yData</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
                        <span class="n">minVal</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">yData</span><span class="p">)</span>
                        <span class="n">yData</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">minVal</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">yData</span><span class="p">]</span>
                    
                        <span class="c1"># Get the coefficients of the polynomial fit</span>
                        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xData</span><span class="p">,</span><span class="n">yData</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">polyfit_order</span><span class="p">)</span>
                    
                        <span class="c1"># Create the polynomial function object</span>
                        <span class="n">poly</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
                    
                        <span class="c1"># Check if this is a minimization or maximization problem</span>
                        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                            <span class="c1"># It is maximization</span>
                        
                            <span class="c1"># Check if the case exceeds the polynomial fit&#39;s expected value</span>
                            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">-</span> <span class="n">minVal</span> <span class="o">&lt;</span> <span class="n">poly</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">polyfit_margin</span><span class="p">):</span>
                                <span class="c1"># It is not, so we can stop looping</span>
                                <span class="n">needs_to_be_rerun</span> <span class="o">=</span> <span class="kc">True</span>
                                
                                <span class="n">box</span><span class="o">.</span><span class="n">re_run_using_this_seed</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">box</span><span class="o">.</span><span class="n">re_run_using_this_seed</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="c1"># It is, so check th enext criteria</span>
                        <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                            <span class="c1"># It is minimization</span>
                        
                            <span class="c1"># Check if the case is less than tshe polynomial fit&#39;s expected value</span>
                            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">-</span> <span class="n">minVal</span> <span class="o">&gt;</span> <span class="n">poly</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">polyfit_margin</span><span class="p">):</span>
                                <span class="c1"># It is not, so we can stop looping</span>
                                <span class="n">needs_to_be_rerun</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">box</span><span class="o">.</span><span class="n">re_run_using_this_seed</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">box</span><span class="o">.</span><span class="n">re_run_using_this_seed</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="c1"># It is, so check the next criteria</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">box</span><span class="o">.</span><span class="n">re_run_using_this_seed</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">needs_to_be_rerun</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Not enough seed_boxes, assume it must be re-run</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Needs to be re-run: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">needs_to_be_rerun</span><span class="p">:</span>
                    <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Needs to be re-run: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                    
                
        <span class="c1"># All done, return the boxes</span>
        <span class="k">return</span> <span class="n">boxes_out</span></div>
        
<div class="viewcode-block" id="PEATSAwaiter.find_all_seed_cases"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.find_all_seed_cases">[docs]</a>    <span class="k">def</span> <span class="nf">find_all_seed_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAboxes2run</span><span class="p">,</span><span class="n">PEATSAboxes</span><span class="p">,</span><span class="n">external_seed_boxes</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finding all seed cases for all cases&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize the output list</span>
        <span class="n">boxes_out</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Loop through all cases</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">PEATSAboxes2run</span><span class="p">:</span>
            
            <span class="c1"># Find the seed cases for this case</span>
            <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_seed_cases</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">PEATSAboxes</span> <span class="o">+</span> <span class="n">external_seed_boxes</span><span class="p">)</span>
            
            <span class="c1"># append the returned box. The returned box is the same, except that the seed cases have been set</span>
            <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
            
        <span class="c1"># Return the full list</span>
        <span class="k">return</span> <span class="n">boxes_out</span></div>
        
<div class="viewcode-block" id="PEATSAwaiter.find_seed_cases"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.find_seed_cases">[docs]</a>    <span class="k">def</span> <span class="nf">find_seed_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAbox</span><span class="p">,</span><span class="n">PEATSAboxes</span><span class="p">,</span><span class="n">include_infeasible</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">solo_criteria</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finding all seeed cases for: &quot;</span> <span class="o">+</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
        
                
        <span class="k">if</span> <span class="n">solo_criteria</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loop_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="n">solo_criteria</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Re-set the list of seeds</span>
            <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_boxes</span> <span class="o">=</span> <span class="p">{}</span>
        
            <span class="n">loop_criteria</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">seed_criteria</span>       
                
        <span class="c1"># Loop through all the seed criteria</span>
        <span class="k">for</span> <span class="n">seed_criteria</span> <span class="ow">in</span> <span class="n">loop_criteria</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_boxes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Add a new empty list for each seed criteria</span>
                <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_boxes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]:[]})</span>
        
            <span class="c1"># Get the target fingerprint</span>
            <span class="n">target_fingerprint</span> <span class="o">=</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># The boxes should be sorted, so once we find the section of boxes that match, we dont have to keep looking.</span>
            <span class="c1"># So, create a flag to indicate when that section of boxes is found</span>
            <span class="n">found_matching_section</span> <span class="o">=</span> <span class="mi">0</span>
        
            <span class="c1"># Loop through all the other cases</span>
            <span class="k">for</span> <span class="n">possible_seed</span> <span class="ow">in</span> <span class="n">PEATSAboxes</span><span class="p">:</span>
                    
                <span class="c1"># Get the possible seeds fingerprint</span>
                <span class="n">possible_seed_fingerprint</span> <span class="o">=</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Check if the cases have the same fingerprint, excluding the seed criteria of note</span>
                <span class="k">if</span> <span class="n">target_fingerprint</span> <span class="o">==</span> <span class="n">possible_seed_fingerprint</span><span class="p">:</span>
                
                    <span class="c1"># Update the flag</span>
                    <span class="n">found_matching_section</span> <span class="o">=</span> <span class="mi">1</span>
                
                    <span class="c1"># Check if the seed is to far away from the current case or if we care:</span>
                    <span class="k">if</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>

                         <span class="c1"># Too far, try the next</span>
                         <span class="k">continue</span>
                         
                    <span class="k">if</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>

                         <span class="c1"># Too far, try the next</span>
                         <span class="k">continue</span>
                
                    <span class="c1"># Check if we are allowe to seed ourselves</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">in_study</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">allow_cases_to_seed_themselves</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># we are not and this the same case</span>
                        <span class="k">continue</span>
                
                    <span class="c1"># Check if the potential seed converged, and can therefore be used as a seed, or if we dont care</span>
                    <span class="k">if</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">converged</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">include_infeasible</span><span class="p">:</span>
                        <span class="c1"># It did, or we dont care</span>
                    
                        <span class="c1"># Make sure that if this case hasnt converged, that it it actually has an infeasible .emtg file written out</span>
                        <span class="k">if</span> <span class="n">include_infeasible</span> <span class="ow">and</span> <span class="s2">&quot;fake&quot;</span> <span class="ow">in</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">PEATSAcrust_path</span><span class="p">:</span>
                            <span class="c1"># It doesnt.</span>
                            <span class="k">continue</span>
                    
                        <span class="c1"># Check if we need to determine if the seed case met the objective</span>
                        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">seed_from_cases_that_havent_met_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># We do</span>
                        
                            <span class="c1"># Check if this is a minimization or maximizatino problem</span>
                            <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                                <span class="c1"># It is a maximization</span>
                            
                                <span class="c1"># Check if the case met the goal criteria</span>
                                <span class="k">if</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">&lt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">peatsa_goal_objective</span><span class="p">:</span>
                                    
                                    <span class="c1"># It did not. Continue to the next potential seed</span>
                                    <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                                <span class="c1"># It is a maximization</span>
                            
                                <span class="c1"># Check if the case met the goal criteria</span>
                                <span class="k">if</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">peatsa_goal_objective</span><span class="p">:</span>
                                    
                                    <span class="c1"># It did not. Continue to the next potential seed</span>
                                    <span class="k">continue</span>
                                    
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found a seeder. &quot;</span> <span class="o">+</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">mission_name</span> <span class="o">+</span> <span class="s2">&quot; seeded by &quot;</span> <span class="o">+</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thin_crust</span><span class="p">:</span>
                            <span class="kn">import</span> <span class="nn">Mission</span>
                            <span class="n">SM</span> <span class="o">=</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Mission</span><span class="p">(</span><span class="n">possible_seed</span><span class="o">.</span><span class="n">PEATSApath</span> <span class="o">+</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">PEATSAcrust_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">SM</span> <span class="o">=</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">PEATSAcrust</span>
                        <span class="n">seed_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">possible_seed</span><span class="o">.</span><span class="n">mission_name</span><span class="p">,</span><span class="n">possible_seed</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">possible_seed</span><span class="o">.</span><span class="n">objective_value</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">Xdescriptions</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">,</span><span class="n">possible_seed</span><span class="o">.</span><span class="n">PEATSApath</span> <span class="o">+</span> <span class="n">possible_seed</span><span class="o">.</span><span class="n">PEATSAcrust_path</span><span class="p">)</span>                

                        <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed_code</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">seed_from_infeasible_cases_if_no_feasible_seeds_found</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAbox</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">solo_criteria</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">PEATSAbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_seed_cases</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAbox</span><span class="p">,</span><span class="n">PEATSAboxes</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">seed_criteria</span><span class="p">)</span>
                    
                <span class="c1"># # Check if we can stop searching because this is the first criterion in the criteria list (true also if its the only one)</span>
                <span class="c1"># elif (seed_criteria[0] == PEATSAorder.seed_criteria[0][0]) and found_matching_section == 1:</span>
                <span class="c1">#</span>
                <span class="c1">#     # We are no longer in the matching section, so we can stop searching</span>
                <span class="c1">#     break</span>
             
        <span class="c1"># return the PEATSAbox with the seed list set</span>
        <span class="k">return</span> <span class="n">PEATSAbox</span></div>
    
<div class="viewcode-block" id="PEATSAwaiter.reseed"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.reseed">[docs]</a>    <span class="k">def</span> <span class="nf">reseed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAboxes</span><span class="p">,</span><span class="n">history</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Selecting a new seed for all cases&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize the output array</span>
        <span class="n">boxes_out</span> <span class="o">=</span> <span class="p">[]</span>
                
        <span class="c1"># Loop through all the cases</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">PEATSAboxes</span><span class="p">:</span>  
        
            <span class="c1"># Create a tracker to note if an unseeded case has been written yet</span>
            <span class="n">unseeded_written</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1"># Check if we are overriding the local seed_criteria </span>
            <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">only_one_seed_in_all_seed_directions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># We must accumulate a list of all seed criteria</span>
                <span class="n">net_seed_cases</span> <span class="o">=</span> <span class="p">[]</span>
                                
                <span class="c1"># Loop through the different seed criterion</span>
                <span class="k">for</span> <span class="n">seed_criteria</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">:</span>
                    <span class="n">net_seed_cases</span> <span class="o">+=</span> <span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                
                <span class="c1"># Make sure there are some cases</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">net_seed_cases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>        
                    <span class="c1"># Call the seed from all routine with the net seed case list</span>
                    <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">only_one_seed_in_all_seed_directions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># seed from best</span>
                        <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_best</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">net_seed_cases</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">only_one_seed_in_all_seed_directions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># seed from random</span>
                        <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_random</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">net_seed_cases</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># invalid input. tell the user and write an unseeded case</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Invalid input value for PEATSAorder.only_one_seed_in_all_seed_directions.&quot;</span><span class="p">)</span>
                        <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_unseeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
                    <span class="c1"># Add the returned case to the stack</span>
                    <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">wait_until_seeded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># No seed were found, but write an unseeded case </span>
                    <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_unseeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
            
                    <span class="c1"># Add the returned case to the stack</span>
                    <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>                
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Loop through the different seed criterion</span>
                <span class="k">for</span> <span class="n">seed_criteria</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">:</span>
                
                    <span class="c1"># Check if there are seeds available</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">unseeded_written</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="c1"># There are not</span>
                
                        <span class="c1"># Update the flag so we dont write anymore unseededs</span>
                        <span class="n">unseeded_written</span> <span class="o">=</span> <span class="kc">True</span>
                
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No seed for &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                        
                        <span class="c1"># Check if we want to wait until this case has a seed?</span>
                        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">wait_until_seeded</span><span class="p">:</span>
                            <span class="c1"># We do. dont write an unseeded case</span>
                            <span class="k">continue</span>
                            
                        <span class="c1"># Write an unseeded case</span>
                        <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_unseeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
                
                        <span class="c1"># Add the returned case to the stack</span>
                        <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                        <span class="c1"># There are seed cases available</span>
                
                        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">objective_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">re_run_using_this_seed</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="k">continue</span>
                                
                        <span class="c1"># Determine the seed criteria</span>
                        <span class="k">if</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_closest</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">history</span><span class="p">)</span>
                
                            <span class="c1"># Add the returned case to the stack</span>
                            <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">out_boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_all</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">history</span><span class="p">)</span>
                
                            <span class="c1"># Add the returned cases to the stack</span>
                            <span class="k">for</span> <span class="n">out_box</span> <span class="ow">in</span> <span class="n">out_boxes</span><span class="p">:</span>
                                <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_best</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">history</span><span class="p">)</span>
                
                            <span class="c1"># Add the returned case to the stack</span>
                            <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_random</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">history</span><span class="p">)</span>
                            
                            <span class="c1"># Add the returned case to the stack</span>
                            <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">seed_criteria</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">out_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_curve_fit</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">box</span><span class="o">.</span><span class="n">seed_boxes</span><span class="p">[</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">seed_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">history</span><span class="p">)</span>
                            
                            <span class="n">boxes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_box</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">boxes_out</span></div>
    
<div class="viewcode-block" id="PEATSAwaiter.seed_from_closest"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.seed_from_closest">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_closest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed_cases</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">history</span><span class="p">):</span>
        
        <span class="c1"># Sort the seeds in the relevant order</span>
        <span class="n">seeds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seed_cases</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">case</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">case</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        
        <span class="c1"># Write the new case, seeded from the closest </span>
        <span class="n">new_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_seeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">history</span><span class="p">)</span>
        
        <span class="c1"># Return the box with the new options</span>
        <span class="k">return</span> <span class="n">new_box</span> </div>
        
<div class="viewcode-block" id="PEATSAwaiter.seed_from_all"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.seed_from_all">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed_cases</span><span class="p">,</span><span class="n">history</span><span class="p">):</span>
        
        <span class="c1"># Initialize the output array</span>
        <span class="n">out_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Loop through all seed cases</span>
        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seed_cases</span><span class="p">:</span>
        
            <span class="c1"># Write the new case, seeded from the closest </span>
            <span class="n">new_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_seeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
        
            <span class="c1"># Add the new box to the stack</span>
            <span class="n">out_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_box</span><span class="p">)</span>
        
        <span class="c1"># Return the box with the new options</span>
        <span class="k">return</span> <span class="n">out_boxes</span></div>
    
<div class="viewcode-block" id="PEATSAwaiter.seed_from_curve_fit"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.seed_from_curve_fit">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed_cases</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">history</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="kn">import</span> <span class="nn">Mission</span>
        
        <span class="c1"># Make sure we have enough cases</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed_cases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">polyfit_order</span><span class="p">:</span>
            <span class="n">polyfit_order</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">polyfit_order</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed_cases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lowering polyfit order for case: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
            <span class="n">polyfit_order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed_cases</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not enough cases for a curve fit for case: &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_closest</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed_cases</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
            
        <span class="c1"># Save the nomianl initial guess type</span>
        <span class="n">nominal_initial_guess_type</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">initial_guess_type</span>
        
        <span class="c1"># Override the initial guess type</span>
        <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">initial_guess_type</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span>
                
        <span class="c1"># Overwrite the mission name</span>
        <span class="n">dummy_seed_mission_name</span> <span class="o">=</span> <span class="s2">&quot;Average_of&quot;</span>
            
        <span class="c1"># Update the dummy seeds objective_value</span>
        <span class="n">dummy_seed_objective_value</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># Initialize a list of usable seeds</span>
        <span class="n">usable_seeds</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Loop through all the seed cases</span>
        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seed_cases</span><span class="p">:</span>
            
            <span class="c1"># Update the name</span>
            <span class="n">dummy_seed_mission_name</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Update the objective value</span>
            <span class="n">dummy_seed_objective_value</span> <span class="o">+=</span> <span class="n">seed</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="c1"># Create a flag if the dummy needs to be interpolated</span>
            <span class="n">needs_interp</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1"># Make sure the seed is the same length</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">):</span>
                <span class="c1"># It isnt, so we need to interpolate the timesteps</span>
                <span class="n">needs_interp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Loop through all decision vector variables</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">descrip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="c1"># Make sure all of the decision variable descriptions are the same</span>
                    <span class="k">if</span> <span class="n">descrip</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">needs_interp</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    
            <span class="k">if</span> <span class="n">needs_interp</span><span class="p">:</span>        
                    
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating an interpolated initial guess: &quot;</span> <span class="o">+</span> <span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; for &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
                
                <span class="c1"># Create a holder for the number of timesteps per journey</span>
                <span class="n">nSteps</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="c1"># Loop through each journey</span>
                <span class="k">for</span> <span class="n">JO</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">Journeys</span><span class="p">:</span>
                    <span class="c1"># Check if this journey overrides the global number of steps or not and append the number of steps</span>
                    <span class="k">if</span> <span class="n">JO</span><span class="o">.</span><span class="n">override_num_steps</span><span class="p">:</span>
                        <span class="n">nSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">)</span>
                
                <span class="c1"># Call the interpolator to get a new mission optiosn structure with the improved initial guess</span>
                <span class="n">SM</span> <span class="o">=</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Mission</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">newMO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified_timestep_initial_guess_generator</span><span class="p">(</span><span class="n">SM</span><span class="p">,</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="p">),</span><span class="s2">&quot;n_steps&quot;</span><span class="p">,</span><span class="n">nSteps</span><span class="p">)</span>
                
                <span class="c1"># Copy the seed since we are going to overwrite its decision vector</span>
                <span class="n">temp_seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">seed</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">seed</span><span class="p">[</span><span class="mi">2</span><span class="p">],[</span><span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">newMO</span><span class="o">.</span><span class="n">trialX</span><span class="p">],[</span><span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">newMO</span><span class="o">.</span><span class="n">trialX</span><span class="p">])</span>
                
                <span class="c1"># Loop through all decision vector variables</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">descrip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temp_seed</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="c1"># Make sure all of the decision variable descriptions are the same</span>
                    <span class="k">if</span> <span class="n">descrip</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This case has the wrong decisionv ector structure: &quot;</span> <span class="o">+</span> <span class="n">descrip</span> <span class="o">+</span> <span class="s2">&quot; vs &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Dont need to do anything, just copy the seed into a new variable</span>
                <span class="n">temp_seed</span> <span class="o">=</span> <span class="n">seed</span>              
                    
            <span class="c1"># Add this seed to the usable seed list</span>
            <span class="n">usable_seeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_seed</span><span class="p">)</span>
        
        <span class="c1"># Initialize the new decision vector</span>
        <span class="n">new_dv_values</span> <span class="o">=</span> <span class="p">[]</span>       
            
        <span class="c1"># Loop through the decision vector entries</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">)):</span>
            
            <span class="c1"># Polyfit is a member of numpy, so import it</span>
            <span class="kn">import</span> <span class="nn">numpy</span>
        
            <span class="c1"># Get the arrays of data that make the polyfit</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[</span><span class="n">seed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">usable_seeds</span><span class="p">]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[</span><span class="n">seed</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">usable_seeds</span><span class="p">]</span>
        
            <span class="c1"># Get the coefficients of the polynomial fit</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xData</span><span class="p">,</span><span class="n">yData</span><span class="p">,</span><span class="n">polyfit_order</span><span class="p">)</span>
        
            <span class="c1"># Create the polynomial function object</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>            
            
            <span class="c1"># Assign the new decision vector value</span>
            <span class="n">new_dv_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">poly</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">seed_criteria</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="p">)</span>
                
        <span class="c1"># Create the new dummy seed        </span>
        <span class="n">dummy_seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">dummy_seed_mission_name</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">dummy_seed_objective_value</span><span class="p">,[</span><span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="o">.</span><span class="n">trialX</span><span class="p">],</span><span class="n">new_dv_values</span><span class="p">)</span>        
                    
        <span class="c1"># Write the new case, seeded fromt he dummy </span>
        <span class="n">new_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_seeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">dummy_seed</span><span class="p">,</span><span class="n">history</span><span class="p">)</span>
                
        <span class="c1"># Put the initial guess type back</span>
        <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">initial_guess_type</span> <span class="o">=</span> <span class="n">nominal_initial_guess_type</span>
        
        <span class="c1"># Return the box with the new options</span>
        <span class="k">return</span> <span class="n">new_box</span></div>
        
<div class="viewcode-block" id="PEATSAwaiter.seed_from_best"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.seed_from_best">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_best</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed_cases</span><span class="p">,</span><span class="n">history</span><span class="p">):</span>
        
        <span class="c1"># Sort the seeds in the relevant order</span>
        <span class="n">seeds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seed_cases</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">case</span><span class="p">:</span> <span class="n">case</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># Write the new case, seeded from the closest </span>
        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">new_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_seeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seeds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">history</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">max_or_min</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="n">new_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_seeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">history</span><span class="p">)</span>
        
        <span class="c1"># Return the box with the new options</span>
        <span class="k">return</span> <span class="n">new_box</span></div>
        
<div class="viewcode-block" id="PEATSAwaiter.seed_from_random"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.seed_from_random">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed_cases</span><span class="p">,</span><span class="n">history</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">random</span>
        
        <span class="c1"># Write the new case, seeded from the closest </span>
        <span class="n">new_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_seeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed_cases</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">seed_cases</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span><span class="n">history</span><span class="p">)</span>
        
        <span class="c1"># Return the box with the new options</span>
        <span class="k">return</span> <span class="n">new_box</span></div>
           
<div class="viewcode-block" id="PEATSAwaiter.write_seeded_case"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.write_seeded_case">[docs]</a>    <span class="k">def</span> <span class="nf">write_seeded_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">history</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">Mission</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="kn">import</span> <span class="nn">PEATSAbox</span>
        
        <span class="c1"># NH added a try/except block on 1/4/2022 because I was tired of getting</span>
        <span class="c1"># errors like </span>
        <span class="c1"># MO.trialX.append([seed[3][idx],seed[4][idx]])</span>
        <span class="c1"># IndexError: list index out of range</span>
        <span class="c1">#</span>
        <span class="c1"># I wasn&#39;t sure what the cause actually was, so I just put the whole</span>
        <span class="c1"># thing in a try/except block and told it to use create un unseeded case</span>
        <span class="c1"># if creating the seeded case failed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing a new seeded options file for case &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, using seed &quot;</span> <span class="o">+</span> <span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            
            <span class="c1"># Copy the existing options object</span>
            <span class="n">MO</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="p">)</span>
            
            <span class="c1"># Get the new mission name</span>
            <span class="n">MO</span><span class="o">.</span><span class="n">mission_name</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_seeded_by_&quot;</span> <span class="o">+</span> <span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Update the working directory</span>
            <span class="n">MO</span><span class="o">.</span><span class="n">forced_working_directory</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">results_directory</span>
            
            <span class="c1"># Turn seeding on, if it wasnt already</span>
            <span class="n">MO</span><span class="o">.</span><span class="n">seed_MBH</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="c1"># Move the decision vector over</span>
            <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">initial_guess_type</span> <span class="o">==</span> <span class="s1">&#39;copy&#39;</span><span class="p">:</span>
                <span class="n">MO</span><span class="o">.</span><span class="n">trialX</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
                    <span class="n">MO</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seed</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span><span class="n">seed</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">SM</span> <span class="o">=</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Mission</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">MO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified_timestep_initial_guess_generator</span><span class="p">(</span><span class="n">SM</span><span class="p">,</span><span class="n">MO</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">initial_guess_type</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">new_timestep</span><span class="p">)</span>       
            
            <span class="c1"># Get a tuple of the seed name and its objective value</span>
            <span class="n">seed_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">seed</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
            <span class="c1"># Assume that we should not skip the first nlp run</span>
            <span class="n">MO</span><span class="o">.</span><span class="n">skip_first_nlp_run</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Check the history to see if these seed has been used before</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Loop through the iterations</span>
            <span class="k">for</span> <span class="n">iter_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Keep a flag if we need to break out of this loop</span>
                <span class="n">break_out</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Check if this case was run in the previous iteration</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># It was. Check if the seed was used in the previous iteration</span>
                    <span class="k">if</span> <span class="n">seed_code</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
                        <span class="c1"># Make sure the case actually ran, because the iteration might have been killed</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># It was. Loop through the run history from that iteration</span>
                            <span class="k">for</span> <span class="n">prev_entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
                                <span class="c1"># Check if this run is the one with the relevant seed</span>
                                <span class="k">if</span> <span class="n">prev_entry</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">seed_code</span><span class="p">:</span>
                                    <span class="c1"># It is. </span>
                                
                                    <span class="c1"># Check if the run from the previous generation usign this seed improved</span>
                                    <span class="k">if</span> <span class="n">prev_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="c1"># It didnt improve but it also didnt finish, so dont stop searching backwards</span>
                                        <span class="k">pass</span>
                                    <span class="k">elif</span> <span class="n">prev_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="c1"># IT did not improve. We should skip the first nlp run</span>
                                        <span class="n">MO</span><span class="o">.</span><span class="n">skip_first_nlp_run</span> <span class="o">=</span> <span class="mi">1</span>
                                        <span class="c1"># Because we found the most recent time this case has been run with this seed we can stop looping now</span>
                                        <span class="n">break_out</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># It did. And it did improve so we should keep skip first nlp run = 0 </span>
                                        <span class="c1"># Because we found the most recent time this case has been run with this seed we can stop looping now</span>
                                        <span class="n">break_out</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">break_out</span><span class="p">:</span>
                    <span class="k">break</span>
                    
            <span class="c1"># Apply the override options</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_options</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;SMO&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">SMO</span> <span class="o">=</span> <span class="n">MissionOptions</span><span class="o">.</span><span class="n">MissionOptions</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                    <span class="c1"># Check the condition</span>
                    <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="s2">&quot;SMO&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;SMO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">SMO</span> <span class="o">=</span> <span class="n">MissionOptions</span><span class="o">.</span><span class="n">MissionOptions</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                        
                        <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;MO&quot;</span><span class="p">):</span>
                            <span class="n">varname</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;MO.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s2">&quot;Journeys&quot;</span> <span class="ow">in</span> <span class="n">varname</span><span class="p">:</span>
                                <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;].&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">obj</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">obj</span> <span class="o">=</span> <span class="n">MO</span>
                        
                            <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">varname</span><span class="p">:</span>
                                <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  
                                                
                            <span class="k">if</span> <span class="n">varname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WARNING: Override might not work, because &quot;</span> <span class="o">+</span> <span class="n">varname</span> <span class="o">+</span> <span class="s2">&quot; doesnt seem to be in PyEMTG Mission Options or Journey Options&quot;</span><span class="p">)</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Option: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>
                                
                        <span class="c1"># It evaluated true, so apply it</span>
                        <span class="n">exec</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WARNING: Unable to override an option because:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Option: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>
                    <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*******************************************&quot;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">e</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="s2">&quot;^&quot;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*******************************************&quot;</span><span class="p">)</span>
                             
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">constraint_walking</span><span class="p">):</span>    
                <span class="c1"># Keep a counter of how many times this case has been run since last improvement</span>
                <span class="n">nRuns</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Check the history to see if these seed has been used before</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Loop through the iterations</span>
                <span class="k">for</span> <span class="n">iter_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Keep a flag if we need to break out of this loop</span>
                    <span class="n">break_out</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Check if this case was run in the previous iteration</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># It was. Check if the seed was used in the previous iteration</span>
                        <span class="k">if</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nRuns</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Last improvement: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nRuns</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; iterations ago&quot;</span><span class="p">)</span>      
            
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">walk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">constraint_walking</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nRuns</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nRuns</span><span class="p">)</span><span class="o">/</span><span class="n">walk</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="n">nRuns</span><span class="p">)</span><span class="o">/</span><span class="n">walk</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Walking constraint: &quot;</span> <span class="o">+</span> <span class="n">walk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">exec</span><span class="p">(</span><span class="n">walk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; += &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">walk</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            
            <span class="c1"># Write the options file out</span>
            <span class="n">MO</span><span class="o">.</span><span class="n">write_options_file</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">MO</span><span class="o">.</span><span class="n">mission_name</span> <span class="o">+</span> <span class="s2">&quot;.emtgopt&quot;</span><span class="p">)</span>
            
            <span class="c1"># Create a new peatsa box to hold the new case</span>
            <span class="n">new_box</span> <span class="o">=</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">PEATSAbox</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span><span class="p">,</span><span class="n">MO</span><span class="o">.</span><span class="n">mission_name</span> <span class="o">+</span> <span class="s2">&quot;.emtgopt&quot;</span><span class="p">)</span>
        
            <span class="c1"># Make a note of the mission name used to seed and the objective value of the seed</span>
            <span class="n">new_box</span><span class="o">.</span><span class="n">used_seed</span> <span class="o">=</span> <span class="n">seed_code</span>
        
            <span class="c1"># Return the new box</span>
            <span class="k">return</span> <span class="n">new_box</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># creating a seeded case failed</span>
            <span class="c1"># create an unseeded case instead</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WARNING: Created a seeded options file failed.&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating an unseeded options file instead.&quot;</span><span class="p">)</span>
            <span class="n">new_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_unseeded_case</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
            
            <span class="c1"># Return the new box</span>
            <span class="k">return</span> <span class="n">new_box</span></div>
            
<div class="viewcode-block" id="PEATSAwaiter.write_unseeded_case"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.write_unseeded_case">[docs]</a>    <span class="k">def</span> <span class="nf">write_unseeded_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">box</span><span class="p">,</span><span class="n">history</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">Mission</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="kn">import</span> <span class="nn">PEATSAbox</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing a new unseeded options file for case &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="p">)</span>
        
        <span class="c1"># Copy the existing options object</span>
        <span class="n">MO</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough</span><span class="p">)</span>
        
        <span class="c1"># Get the new mission name</span>
        <span class="n">MO</span><span class="o">.</span><span class="n">mission_name</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Update the working directory</span>
        <span class="n">MO</span><span class="o">.</span><span class="n">forced_working_directory</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">results_directory</span>
        
        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">seed_from_infeasible_self_when_unseeded</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span><span class="s1">&#39;PEATSAcrust_path&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAcrust_path</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;fake&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAcrust_path</span><span class="p">:</span>
                <span class="n">MO</span><span class="o">.</span><span class="n">trialX</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">thin_crust</span><span class="p">:</span>
                    <span class="n">M</span> <span class="o">=</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Mission</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSApath</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAcrust_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAcrust</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">)):</span>
                    <span class="n">MO</span><span class="o">.</span><span class="n">trialX</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">M</span><span class="o">.</span><span class="n">Xdescriptions</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">M</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                <span class="n">MO</span><span class="o">.</span><span class="n">seed_MBH</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">turn_off_seed_MBH_when_unseeded</span><span class="p">:</span>
                <span class="c1"># Turn seeding off, if it wasnt already</span>
                <span class="n">MO</span><span class="o">.</span><span class="n">seed_MBH</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">MO</span><span class="o">.</span><span class="n">seed_MBH</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">turn_off_seed_MBH_when_unseeded</span><span class="p">:</span>
            <span class="c1"># Turn seeding off, if it wasnt already</span>
            <span class="n">MO</span><span class="o">.</span><span class="n">seed_MBH</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">MO</span><span class="o">.</span><span class="n">seed_MBH</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Apply the override options</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">override_options</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;SMO&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">SMO</span> <span class="o">=</span> <span class="n">MissionOptions</span><span class="o">.</span><span class="n">MissionOptions</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                <span class="c1"># Check the condition</span>
                <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="s2">&quot;SMO&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;SMO&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">SMO</span> <span class="o">=</span> <span class="n">MissionOptions</span><span class="o">.</span><span class="n">MissionOptions</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;MO&quot;</span><span class="p">):</span>
                        <span class="n">varname</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;MO.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;Journeys&quot;</span> <span class="ow">in</span> <span class="n">varname</span><span class="p">:</span>
                            <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;].&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">obj</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">obj</span> <span class="o">=</span> <span class="n">MO</span>
                    
                        <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">varname</span><span class="p">:</span>
                            <span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  
                                            
                        <span class="k">if</span> <span class="n">varname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WARNING: Override might not work, because &quot;</span> <span class="o">+</span> <span class="n">varname</span> <span class="o">+</span> <span class="s2">&quot; doesnt seem to be in PyEMTG Mission Options or Journey Options&quot;</span><span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Option: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>
                            
                    <span class="c1"># It evaluated true, so apply it</span>
                    <span class="n">exec</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WARNING: Unable to override an option because:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Option: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>
                <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*******************************************&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">e</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="s2">&quot;^&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*******************************************&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">constraint_walking</span><span class="p">):</span>   
            <span class="c1"># Keep a counter of how many times this case has been run since last improvement</span>
            <span class="n">nRuns</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">history</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="c1"># Check the history to see if these seed has been used before</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mission_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_seeded_by&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Loop through the iterations</span>
                <span class="k">for</span> <span class="n">iter_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Keep a flag if we need to break out of this loop</span>
                    <span class="n">break_out</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Check if this case was run in the previous iteration</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># It was. Check if the seed was used in the previous iteration</span>
                        <span class="k">if</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">iter_idx</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nRuns</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Last improvement: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nRuns</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; iterations ago&quot;</span><span class="p">)</span>      
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">walk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">constraint_walking</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nRuns</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nRuns</span><span class="p">)</span><span class="o">/</span><span class="n">walk</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="n">nRuns</span><span class="p">)</span><span class="o">/</span><span class="n">walk</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Walking constraint: &quot;</span> <span class="o">+</span> <span class="n">walk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">walk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; += &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">walk</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            
        <span class="c1"># Write the options file out</span>
        <span class="n">MO</span><span class="o">.</span><span class="n">write_options_file</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">MO</span><span class="o">.</span><span class="n">mission_name</span> <span class="o">+</span> <span class="s2">&quot;.emtgopt&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create a new peatsa box to hold the new case</span>
        <span class="n">new_box</span> <span class="o">=</span> <span class="n">PEATSAbox</span><span class="o">.</span><span class="n">PEATSAbox</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span><span class="p">,</span><span class="n">MO</span><span class="o">.</span><span class="n">mission_name</span> <span class="o">+</span> <span class="s2">&quot;.emtgopt&quot;</span><span class="p">)</span>
    
        <span class="c1"># Return the new box</span>
        <span class="k">return</span> <span class="n">new_box</span></div>
    
<div class="viewcode-block" id="PEATSAwaiter.CreateSplines"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.CreateSplines">[docs]</a>    <span class="k">def</span> <span class="nf">CreateSplines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reference_ephem</span><span class="p">,</span><span class="n">current_epoch</span><span class="p">,</span><span class="n">turn_off_point_density_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
        
        <span class="c1"># Star the index at zero</span>
        <span class="n">reference_ephem_index</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Find the most recent ephemeris</span>
        <span class="c1"># Get the date of the ephemeris at the current index:</span>
        <span class="n">ephem_epoch</span> <span class="o">=</span> <span class="n">reference_ephem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">reference_ephem_index</span><span class="p">]</span>
        <span class="c1"># Loop through the ephemeris data until we are past the current_epoch</span>
        <span class="k">while</span> <span class="n">ephem_epoch</span> <span class="o">&lt;</span> <span class="n">current_epoch</span><span class="p">:</span>
            <span class="c1"># Increment the index</span>
            <span class="n">reference_ephem_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Update the date</span>
            <span class="n">ephem_epoch</span> <span class="o">=</span> <span class="n">reference_ephem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">reference_ephem_index</span><span class="p">]</span>
        
        <span class="c1"># Check if the lhs point is closer to the current epoch than the rhs</span>
        <span class="k">if</span> <span class="n">reference_ephem_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ephem_epoch</span> <span class="o">-</span> <span class="n">current_epoch</span> <span class="o">&gt;</span> <span class="n">current_epoch</span> <span class="o">-</span> <span class="n">reference_ephem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">reference_ephem_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># It is, so lets go back to it</span>
            <span class="n">reference_ephem_index</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c1"># Update the date</span>
            <span class="n">ephem_epoch</span> <span class="o">=</span> <span class="n">reference_ephem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">reference_ephem_index</span><span class="p">]</span>
                            
        <span class="c1"># We should now have the index into the reference ephemeris data</span>
        <span class="c1"># But lets make sure that we arent too far off, timewise</span>
        <span class="k">if</span> <span class="n">turn_off_point_density_check</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ephem_epoch</span><span class="o">-</span><span class="n">current_epoch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="c1"># We should always have ephemeris closer to the current epoch than half a day, </span>
                <span class="c1"># because we should always have ephemeris at at least 1 day intervals. Because we dont</span>
                <span class="c1"># I dont trust this ephemeris, so throw an error</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not able to find an ephemeris data point within .5 days of the desired missed thrust date (JD&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; vs JD&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ephem_epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;). Either the ephemeris is out of order, or it is not dense enough. Current index into the ephemeris = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">reference_ephem_index</span><span class="p">))</span>
    
        <span class="c1"># Get the first index to use for the spline. Note we are making a spline with only +- 5 points around the missed thrust date because it is too costly to load the full journey let alone mission</span>
        <span class="k">if</span> <span class="n">reference_ephem_index</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">spline_start_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spline_start_index</span> <span class="o">=</span> <span class="n">reference_ephem_index</span> <span class="o">-</span> <span class="mi">5</span>
                        
        <span class="c1"># Check that the phase start isnt within 10 entries of the end of the data</span>
        <span class="k">if</span> <span class="n">spline_start_index</span> <span class="o">+</span> <span class="mi">11</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_ephem</span><span class="p">[</span><span class="mi">7</span><span class="p">]):</span>
            <span class="n">spline_start_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_ephem</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">-</span> <span class="mi">10</span>                
                            
        <span class="c1"># Initialize the spline list</span>
        <span class="n">reference_splines</span> <span class="o">=</span> <span class="p">[]</span>
                               
        <span class="c1"># Create the splines and add them to the list</span>
        <span class="k">for</span> <span class="n">spline_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reference_splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp1d</span><span class="p">(</span><span class="n">reference_ephem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">spline_start_index</span><span class="p">:</span><span class="n">spline_start_index</span><span class="o">+</span><span class="mi">10</span><span class="p">],</span><span class="n">reference_ephem</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">spline_idx</span><span class="p">][</span><span class="n">spline_start_index</span><span class="p">:</span><span class="n">spline_start_index</span><span class="o">+</span><span class="mi">10</span><span class="p">],</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">reference_splines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp1d</span><span class="p">(</span><span class="n">reference_ephem</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">spline_start_index</span><span class="p">:</span><span class="n">spline_start_index</span><span class="o">+</span><span class="mi">10</span><span class="p">],</span><span class="n">reference_ephem</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">spline_idx</span><span class="p">][</span><span class="n">spline_start_index</span><span class="p">:</span><span class="n">spline_start_index</span><span class="o">+</span><span class="mi">10</span><span class="p">],</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
                    
                        
        <span class="k">return</span> <span class="n">reference_splines</span></div>
     
<div class="viewcode-block" id="PEATSAwaiter.get_ephem_lists_from_emtg_mission"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.get_ephem_lists_from_emtg_mission">[docs]</a>    <span class="k">def</span> <span class="nf">get_ephem_lists_from_emtg_mission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">M</span><span class="p">):</span>
        
        <span class="c1"># Initialize the lists:</span>
        <span class="n">ephem_lists</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
        
        <span class="c1"># loop through the journeys</span>
        <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">Journeys</span><span class="p">:</span>
            
            <span class="c1"># Loop through the events</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">JulianDate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ephem_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># Get the epoch</span>
                    <span class="n">ephem_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">JulianDate</span><span class="p">)</span>
                
                    <span class="c1"># Loop through the states</span>
                    <span class="k">for</span> <span class="n">sdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                    
                        <span class="c1"># Append the state</span>
                        <span class="n">ephem_lists</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">sdx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">SpacecraftState</span><span class="p">[</span><span class="n">sdx</span><span class="p">])</span>
                
                    <span class="c1"># APpend the mass</span>
                    <span class="n">ephem_lists</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">Mass</span><span class="p">)</span>
        
        <span class="c1"># Send back the output</span>
        <span class="k">return</span> <span class="n">ephem_lists</span></div>
            
<div class="viewcode-block" id="PEATSAwaiter.modified_timestep_initial_guess_generator"><a class="viewcode-back" href="../PEATSA/PEATSAwaiter.html#PEATSAwaiter.PEATSAwaiter.modified_timestep_initial_guess_generator">[docs]</a>    <span class="k">def</span> <span class="nf">modified_timestep_initial_guess_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SM</span><span class="p">,</span><span class="n">MO</span><span class="p">,</span><span class="n">timestep_type</span><span class="p">,</span><span class="n">timestep_input</span><span class="p">):</span>
        <span class="c1"># SM = seed mission. the initial guess source. it&#39;s journeys have n timesteps per journey (or n1, n2, n3...)</span>
        <span class="c1"># MO = destination mission options. where to put the mission options. It will be given an initial guess and </span>
        <span class="c1">#      m timesteps of ~x days each</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span>
                
        <span class="c1"># Do some error checking</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">SM</span><span class="o">.</span><span class="n">Journeys</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Sorry, this initial guess generator only works with the same number of journeys&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize the decision vector</span>
        <span class="n">new_decision_vector</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Get an index to keep track of where we are in the </span>
        <span class="c1"># seed mission decision vector</span>
        <span class="n">decision_vector_index_tracker</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Get the reference ephem in case we need it</span>
        <span class="n">reference_ephem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ephem_lists_from_emtg_mission</span><span class="p">(</span><span class="n">SM</span><span class="p">)</span>
        
        <span class="c1"># Loop through the journeys</span>
        <span class="k">for</span> <span class="n">jdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">)):</span>
                        
            <span class="c1"># Loop through the phases</span>
            <span class="c1"># Determine if this is a multi-phase Journey.</span>
            <span class="c1"># First, assume it only has one phase</span>
            <span class="n">nPhases</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Loop through all of the sequence values in this Journey</span>
            <span class="k">for</span> <span class="n">seq_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span><span class="o">.</span><span class="n">sequence</span><span class="p">)):</span>
                <span class="c1"># Check if this sequence ID is non-zero, in which case there is a flyby and this is a multiphase journey</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span><span class="o">.</span><span class="n">sequence</span><span class="p">[</span><span class="n">seq_idx</span><span class="p">]):</span>
                    <span class="c1"># It is, update the counter</span>
                    <span class="n">nPhases</span> <span class="o">+=</span> <span class="mi">1</span>
                    
            <span class="c1"># If there are more than 9 phases it will break things, so throw an error</span>
            <span class="k">if</span> <span class="n">nPhases</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Phase number finding code in the decision vector re-creation cant handle more than 9 phases currently&quot;</span><span class="p">)</span>
                                        
            <span class="c1"># # Grab the objects for this Journey and journey options</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">SM</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span>
            <span class="n">JO</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">[</span><span class="n">jdx</span><span class="p">]</span>
            
            <span class="c1"># Loop through all of the phases</span>
            <span class="k">for</span> <span class="n">pdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nPhases</span><span class="p">):</span>
                
                <span class="c1"># We need to figure out if there is a departure and/or arrival coast</span>
                <span class="c1"># Start by assuming both are zero</span>
                <span class="n">sm_departure_coast</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sm_arrival_coast</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">duty_cycle_coast</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sm_control_timestep</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># Then determine whether the journey is single phase or multiphase and whetehr</span>
                <span class="c1"># we are starting in the relevant phase or not</span>
                <span class="k">if</span> <span class="n">pdx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">in_phase</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">in_thrusting</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">in_phase</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Loop through all the events in the journey</span>
                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    
                    <span class="c1"># Check if this is a flyby</span>
                    <span class="k">if</span> <span class="s1">&#39;flyby&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">:</span>
                        <span class="c1"># It is. A phase is starting or ending</span>
                        
                        <span class="c1"># If we were in the phase, we cna stop looping</span>
                        <span class="k">if</span> <span class="n">in_phase</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">in_phase</span> <span class="o">=</span> <span class="kc">True</span> 
                            <span class="n">in_thrusting</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">continue</span>
                    
                    <span class="c1"># Check if we are in the relevant phase or not</span>
                    <span class="k">if</span> <span class="n">in_phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># We arent, so move along to the next event</span>
                        <span class="k">continue</span>
                        
                    <span class="c1"># Check if this is a trhust or coast</span>
                    <span class="k">if</span> <span class="s1">&#39;force-coast&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">:</span>
                        <span class="c1"># It is the forced coast. So just need to determine if it is a departure or arrival</span>
                        <span class="k">if</span> <span class="n">in_thrusting</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">sm_departure_coast</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">TimestepLength</span>
                        <span class="k">elif</span> <span class="n">in_thrusting</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">sm_arrival_coast</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">TimestepLength</span>
                    <span class="k">elif</span> <span class="n">in_thrusting</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="s1">&#39;thrust&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">:</span>
                        <span class="c1"># It isnt a coast, but it is a thrust, so make sure the thrusting flag is set</span>
                        <span class="n">in_thrusting</span> <span class="o">=</span> <span class="kc">True</span>    
                        
                        <span class="c1"># Get the timestep</span>
                        <span class="n">sm_control_timestep</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">TimestepLength</span>            
                    <span class="k">elif</span> <span class="s1">&#39;coast&#39;</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">EventType</span> <span class="ow">or</span> <span class="s2">&quot;nav-coast&quot;</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">:</span>
                        <span class="c1"># Check if this is a realistic duty cycle coast</span>
                        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">TimestepLength</span> <span class="o">&lt;</span> <span class="n">sm_control_timestep</span> <span class="p">:</span>
                            <span class="c1"># It must be</span>
                            <span class="n">duty_cycle_coast</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">TimestepLength</span>
                            
                <span class="c1"># If this is a full coast phase (even though it COULD thrust, EMTG chose not to)</span>
                <span class="k">if</span> <span class="n">sm_control_timestep</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">EventType</span> <span class="o">==</span> <span class="s2">&quot;coast&quot;</span><span class="p">:</span>
                            <span class="n">sm_control_timestep</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">TimestepLength</span>
                        <span class="k">elif</span> <span class="s2">&quot;nav-coast&quot;</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">:</span>
                            <span class="c1"># It must be</span>
                            <span class="n">duty_cycle_coast</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">TimestepLength</span>
                
                <span class="c1"># Add the duty cycle coast ot the control timestep if any</span>
                <span class="n">sm_control_timestep</span> <span class="o">+=</span> <span class="n">duty_cycle_coast</span>    
                
                <span class="n">sm_num_steps</span> <span class="o">=</span> <span class="p">(</span> <span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">JulianDate</span> <span class="o">-</span> <span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">JulianDate</span> <span class="o">-</span> <span class="n">sm_departure_coast</span> <span class="o">-</span> <span class="n">sm_arrival_coast</span> <span class="p">)</span> <span class="o">/</span> <span class="n">sm_control_timestep</span>               
                                
                <span class="c1"># Get the length of the initial coast, if any</span>
                <span class="k">if</span> <span class="n">pdx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">departure_coast</span> <span class="o">=</span> <span class="n">JO</span><span class="o">.</span><span class="n">forced_initial_coast</span>
                    <span class="n">phase_start_epoch</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">JulianDate</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">departure_coast</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">forced_post_flyby_coast</span>
                    <span class="n">phase_start_epoch</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">missionevents</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">JulianDate</span>
                                            
                <span class="c1"># Get the length of the arrival coast, if any</span>
                <span class="k">if</span> <span class="n">pdx</span> <span class="o">==</span> <span class="n">nPhases</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">arrival_coast</span> <span class="o">=</span> <span class="n">JO</span><span class="o">.</span><span class="n">forced_terminal_coast</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arrival_coast</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">forced_pre_flyby_coast</span>
                
                <span class="c1"># Create the decision vector prefix</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;j&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jdx</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pdx</span><span class="p">)</span>
                                
                <span class="c1"># Initialize the transcription string</span>
                <span class="n">transcription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                
                <span class="c1"># Initialize the phase flight time to make sure its been found</span>
                <span class="n">phase_flight_time</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="c1"># Note that we havent found the control start index</span>
                <span class="n">control_start_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                
                <span class="c1"># Loop through the decision vector</span>
                <span class="k">for</span> <span class="n">dv_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">decision_vector_index_tracker</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">SM</span><span class="o">.</span><span class="n">Xdescriptions</span><span class="p">)):</span>
                    
                    <span class="n">currDVvar</span> <span class="o">=</span> <span class="n">SM</span><span class="o">.</span><span class="n">Xdescriptions</span><span class="p">[</span><span class="n">dv_idx</span><span class="p">]</span>
                                        
                    <span class="c1"># Make sure we are in the correct phase</span>
                    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">transcription</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="c1"># Update the tracker</span>
                            <span class="n">decision_vector_index_tracker</span> <span class="o">=</span> <span class="n">dv_idx</span>
                        
                            <span class="c1"># Break the loop</span>
                            <span class="k">break</span>
                    
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Not to the right phase yet</span>
                            <span class="k">continue</span>
                            
                    
                    <span class="c1"># Get the transcription</span>
                    <span class="k">if</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;FBLT&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">:</span>
                            <span class="n">transcription</span> <span class="o">=</span> <span class="s2">&quot;FBLT&quot;</span>
                        <span class="k">elif</span> <span class="s2">&quot;PSFB&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">:</span>
                            <span class="n">transcription</span> <span class="o">=</span> <span class="s2">&quot;PSFB&quot;</span>
                        <span class="k">elif</span> <span class="s2">&quot;MGALT&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">:</span>
                            <span class="n">transcription</span> <span class="o">=</span> <span class="s2">&quot;MGALT&quot;</span>
                        <span class="k">elif</span> <span class="s2">&quot;CoastPhase&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">:</span>
                            <span class="n">transcription</span> <span class="o">=</span> <span class="s2">&quot;Coast&quot;</span> 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This transcription is not in the initial guess utility yet. Sorry&quot;</span><span class="p">)</span>
                          
                    <span class="c1"># Check if we are in the steps yet</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;MGALT&quot;</span> <span class="ow">or</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;FBLT&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;step&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;PSFB&quot;</span> <span class="ow">and</span> <span class="s2">&quot;Step&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">):</span>
                        <span class="c1"># We are in the steps.</span>
                        
                        <span class="c1"># Check if we have already added the control for this phase</span>
                        <span class="k">if</span> <span class="n">control_start_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># We have not</span>
                            
                            <span class="c1"># Note that we have found the control start</span>
                            <span class="n">control_start_index</span> <span class="o">=</span> <span class="n">dv_idx</span>
                        
                            <span class="c1"># Make sure we have the phase flight time</span>
                            <span class="k">if</span> <span class="n">phase_flight_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Phase flight time wasnt found for &quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>
                            
                            <span class="c1"># Set the number of variables per step in the control section</span>
                            <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">3</span>
                        
                            <span class="c1"># If the transcription is parallel shooting, there are actually 12, not 3 variables</span>
                            <span class="k">if</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;PSFB&quot;</span><span class="p">:</span>
                                <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">JO</span><span class="o">.</span><span class="n">num_interior_control_points</span>
                                <span class="k">if</span> <span class="n">JO</span><span class="o">.</span><span class="n">num_interior_control_points</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Time interpolation not setup to handle multiple interior contorl points yet. Use &#39;copy&#39; instead of &#39;x_days&#39; or &#39;n_steps&#39;&quot;</span><span class="p">)</span>
                            
                            <span class="c1"># Override the departure journey number of time steps</span>
                            <span class="n">JO</span><span class="o">.</span><span class="n">override_num_steps</span> <span class="o">=</span> <span class="mi">1</span>
                                                                  
                            <span class="c1"># Calculate the number of timesteps to use from inputs</span>
                            <span class="k">if</span> <span class="n">timestep_type</span> <span class="o">==</span> <span class="s2">&quot;x_days&quot;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestep_input</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestep_input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">):</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not enough entries in new_timestep&quot;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestep_input</span><span class="p">[</span><span class="n">jdx</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">)],</span><span class="nb">list</span><span class="p">):</span>
                                            <span class="n">local_list</span> <span class="o">=</span> <span class="n">timestep_input</span><span class="p">[</span><span class="n">jdx</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">)]</span>
                                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Wrong entry size&quot;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">sm_control_timestep</span> <span class="o">&gt;</span> <span class="n">local_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sm_control_timestep</span> <span class="o">&lt;</span> <span class="n">local_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                                                <span class="n">nDays</span> <span class="o">=</span> <span class="n">sm_control_timestep</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">nDays</span> <span class="o">=</span> <span class="n">local_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Changing to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nDays</span><span class="p">))</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">nDays</span> <span class="o">=</span> <span class="n">timestep_input</span><span class="p">[</span><span class="n">jdx</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">)]</span>
                                        
                                <span class="k">elif</span> <span class="n">timestep_input</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">nDays</span> <span class="o">=</span> <span class="n">timestep_input</span>
                                <span class="k">elif</span> <span class="n">timestep_input</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                                    <span class="n">nDays</span> <span class="o">=</span> <span class="n">sm_control_timestep</span>
                                    
                                <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">phase_flight_time</span> <span class="o">-</span> <span class="n">departure_coast</span> <span class="o">-</span> <span class="n">arrival_coast</span><span class="p">)</span> <span class="o">/</span> <span class="n">nDays</span><span class="p">))</span>
                                                                
                                <span class="c1"># Make sure we have at least one timestep</span>
                                <span class="k">if</span> <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">elif</span> <span class="n">timestep_type</span> <span class="o">==</span> <span class="s2">&quot;n_steps&quot;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestep_input</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestep_input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">):</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not enough entries in new_timestep&quot;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="n">timestep_input</span><span class="p">[</span><span class="n">jdx</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">MO</span><span class="o">.</span><span class="n">Journeys</span><span class="p">)]</span>
                                <span class="k">elif</span> <span class="n">timestep_input</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="n">timestep_input</span>
                                <span class="k">elif</span> <span class="n">timestep_input</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">num_timesteps</span>     
                                <span class="k">elif</span> <span class="n">timestep_input</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                                    <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="n">sm_num_steps</span>                               
                        
                            <span class="c1"># Timestep wont be exactly x. Calculate what it is exactly</span>
                            <span class="n">control_timestep</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_flight_time</span> <span class="o">-</span> <span class="n">arrival_coast</span> <span class="o">-</span> <span class="n">departure_coast</span><span class="p">)</span> <span class="o">/</span> <span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span> 
                        
                            <span class="c1"># if abs(control_timestep - sm_control_timestep)</span>
                        
                            <span class="c1"># Set the current epoch</span>
                            <span class="n">control_epoch</span> <span class="o">=</span> <span class="n">phase_start_epoch</span> <span class="o">+</span> <span class="n">departure_coast</span>
                        
                            <span class="c1"># Set the epoch when sm control started and ended</span>
                            <span class="n">sm_control_start_epoch</span> <span class="o">=</span> <span class="n">phase_start_epoch</span> <span class="o">+</span> <span class="n">sm_departure_coast</span>
                            <span class="n">sm_control_end_epoch</span> <span class="o">=</span> <span class="n">phase_start_epoch</span> <span class="o">+</span> <span class="n">phase_flight_time</span> <span class="o">-</span> <span class="n">sm_arrival_coast</span>
                        
                            <span class="c1"># Loop through the new control steps</span>
                            <span class="k">for</span> <span class="n">control_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">JO</span><span class="o">.</span><span class="n">number_of_steps</span><span class="p">):</span>
                        
                                <span class="c1"># Find the epoch of the midpoint of this control arc</span>
                                <span class="k">if</span> <span class="n">control_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">control_epoch</span> <span class="o">+=</span> <span class="mf">.5</span> <span class="o">*</span> <span class="n">control_timestep</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">control_epoch</span> <span class="o">+=</span> <span class="n">control_timestep</span>
                                        
                                <span class="c1"># Figure out how long its been since the control began</span>
                                <span class="n">time_since_sm_control_start</span> <span class="o">=</span> <span class="n">control_epoch</span> <span class="o">-</span> <span class="n">sm_control_start_epoch</span>
                    
                                <span class="c1"># Determine how far we are fractionally through the phase</span>
                                <span class="n">phase_fraction</span> <span class="o">=</span> <span class="n">time_since_sm_control_start</span> <span class="o">/</span> <span class="p">(</span><span class="n">phase_flight_time</span> <span class="o">-</span> <span class="n">sm_departure_coast</span> <span class="o">-</span> <span class="n">sm_arrival_coast</span><span class="p">)</span>
                                                
                                <span class="c1"># Make sure we didnt overstep </span>
                                <span class="k">if</span> <span class="n">phase_fraction</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="c1"># We did. Check if thats okay</span>
                                    <span class="k">if</span> <span class="n">arrival_coast</span> <span class="o">&lt;</span> <span class="n">sm_arrival_coast</span> <span class="ow">and</span> <span class="n">control_epoch</span> <span class="o">-</span> <span class="n">sm_control_end_epoch</span> <span class="o">&lt;</span> <span class="n">sm_arrival_coast</span> <span class="o">-</span> <span class="n">arrival_coast</span><span class="p">:</span>
                                        <span class="c1"># We are past where we should be, but its okay because we are still inside of the reduced forced coast</span>
                                        <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The closest control step is out of bounds and it shouldnt be&quot;</span><span class="p">)</span>      
                                <span class="k">elif</span> <span class="n">phase_fraction</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># we are before control starts</span>
                                    <span class="k">if</span> <span class="n">departure_coast</span> <span class="o">&lt;</span> <span class="n">sm_departure_coast</span> <span class="ow">and</span> <span class="n">sm_control_start_epoch</span> <span class="o">-</span> <span class="n">control_epoch</span> <span class="o">&lt;</span> <span class="n">sm_departure_coast</span> <span class="o">-</span> <span class="n">departure_coast</span><span class="p">:</span>
                                        <span class="c1"># we are before control starts, but its okay because we are just in the reduced forced coast</span>
                                        <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The closest control step is out of bounds and it shouldnt be&quot;</span><span class="p">)</span>                                         
                                                
                                <span class="c1"># Find the closest control step</span>
                                <span class="n">closest_control_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phase_fraction</span> <span class="o">*</span> <span class="n">sm_control_steps</span><span class="p">))</span>

                                <span class="c1"># Store the closest control step if this is the first step</span>
                                <span class="k">if</span> <span class="n">control_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">first_control_step</span> <span class="o">=</span> <span class="n">closest_control_step</span>
                                                                
                                <span class="c1"># If we are here, it should be okay if the closest control step &gt; number of steps, we just need to not try to extract the decision vector for those</span>
                                <span class="k">if</span> <span class="n">closest_control_step</span> <span class="o">&gt;</span> <span class="n">sm_control_steps</span> <span class="ow">or</span> <span class="n">closest_control_step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># We are past the previous mission&#39;s control phase, so we must have reduced the length of the arrival coast</span>
                                    <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">embed</span>
                                    <span class="n">embed</span><span class="p">()</span>
                                    <span class="n">stop</span>
                                    <span class="c1"># Adding control variables is different depending on transcription, so check what type is being used</span>
                                    <span class="k">if</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;FBLT&quot;</span> <span class="ow">or</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;MGALT&quot;</span><span class="p">:</span>
                                        <span class="c1"># Add the control command to the new decision vector</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;: step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; u_x&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;: step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; u_y&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;: step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; u_z&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                                    <span class="k">elif</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;PSFB&quot;</span><span class="p">:</span>
                                        <span class="kn">import</span> <span class="nn">math</span>
                                                                        
                                        <span class="c1"># Get the ephemeris</span>
                                        <span class="n">reduced_coast_splines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateSplines</span><span class="p">(</span><span class="n">reference_ephem</span><span class="p">,</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                                                                            
                                        <span class="c1"># Get the cartesian state</span>
                                        <span class="n">x</span> <span class="o">=</span> <span class="n">reduced_coast_splines</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                                        <span class="n">y</span> <span class="o">=</span> <span class="n">reduced_coast_splines</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                                        <span class="n">z</span> <span class="o">=</span> <span class="n">reduced_coast_splines</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                                        <span class="n">vx</span> <span class="o">=</span> <span class="n">reduced_coast_splines</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                                        <span class="n">vy</span> <span class="o">=</span> <span class="n">reduced_coast_splines</span><span class="p">[</span><span class="mi">4</span><span class="p">](</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                                        <span class="n">vz</span> <span class="o">=</span> <span class="n">reduced_coast_splines</span><span class="p">[</span><span class="mi">5</span><span class="p">](</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                                                                        
                                        <span class="c1"># Convert to spherical</span>
                                        <span class="c1"># Page 53 http://gmat.sourceforge.net/doc/R2013a/GMATMathSpec.pdf</span>
                                        <span class="n">r</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
                                        <span class="n">v</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vx</span><span class="o">*</span><span class="n">vx</span> <span class="o">+</span> <span class="n">vy</span><span class="o">*</span><span class="n">vy</span> <span class="o">+</span> <span class="n">vz</span><span class="o">*</span><span class="n">vz</span><span class="p">)</span>
                                        <span class="n">RA</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
                                        <span class="n">DEC</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span>
                                        <span class="n">FPA</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">vx</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">vy</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">vz</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">v</span><span class="p">))</span>
                                        <span class="n">vRA</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">vy</span><span class="p">,</span><span class="n">vx</span><span class="p">)</span>
                                        <span class="n">vDEC</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">vz</span><span class="o">/</span><span class="n">v</span><span class="p">)</span>
                                    
                                        <span class="n">xhat</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">DEC</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">RA</span><span class="p">),</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">DEC</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">RA</span><span class="p">),</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">DEC</span><span class="p">)]</span>
                                        <span class="n">yhat</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">RA</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">RA</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="mf">0.0</span><span class="p">]</span>
                                        <span class="n">zhat</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">DEC</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">RA</span><span class="p">),</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">DEC</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">RA</span><span class="p">),</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">DEC</span><span class="p">)]</span>
                                    
                                        <span class="n">vy_prime</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">*</span> <span class="n">yhat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vy</span> <span class="o">*</span> <span class="n">yhat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">vz</span> <span class="o">*</span> <span class="n">yhat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                        <span class="n">vz_prime</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">*</span> <span class="n">zhat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vy</span> <span class="o">*</span> <span class="n">zhat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">vz</span> <span class="o">*</span> <span class="n">zhat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                    
                                        <span class="n">AZ</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">vy_prime</span><span class="p">,</span><span class="n">vz_prime</span><span class="p">)</span>
                                                                        
                                        <span class="c1"># Add the state</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state r&quot;</span><span class="p">,</span><span class="n">r</span><span class="p">])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state RA&quot;</span><span class="p">,</span><span class="n">RA</span><span class="p">])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state DEC&quot;</span><span class="p">,</span><span class="n">DEC</span><span class="p">])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state v&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">])</span>
                                        <span class="k">if</span> <span class="n">MO</span><span class="o">.</span><span class="n">PSFBstateRepresentation</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state vRA&quot;</span><span class="p">,</span><span class="n">vRA</span><span class="p">])</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state vDEC&quot;</span><span class="p">,</span><span class="n">vDEC</span><span class="p">])</span>                                            
                                        <span class="k">elif</span> <span class="n">MO</span><span class="o">.</span><span class="n">PSFBstateRepresentation</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state AZ&quot;</span><span class="p">,</span><span class="n">AZ</span><span class="p">])</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state FPA&quot;</span><span class="p">,</span><span class="n">FPA</span><span class="p">])</span>
                                        <span class="c1"># Add the masses</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state mass&quot;</span><span class="p">,</span><span class="n">reduced_coast_splines</span><span class="p">[</span><span class="mi">6</span><span class="p">](</span><span class="n">control_epoch</span> <span class="o">-</span> <span class="n">control_timestep</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: virtual chemical fuel&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: virtual electric propellant&quot;</span><span class="p">,</span><span class="n">net_ep_used</span><span class="p">])</span>
                                        <span class="k">for</span> <span class="n">ss_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">JO</span><span class="o">.</span><span class="n">num_interior_control_points</span><span class="p">):</span>
                                        <span class="c1"># Add the control command to the new decision vector</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: substep&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ss_idx</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot; u_x&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: substep&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ss_idx</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot; u_y&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: substep&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ss_idx</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot; u_z&quot;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
                                    
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># This step is within the decision vector of hte initial guess, so just get those values and add them to the new decision vector</span>
                                
                                    <span class="c1"># Find the index of this control step</span>
                                    <span class="n">closest_control_index</span> <span class="o">=</span> <span class="n">closest_control_step</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">+</span> <span class="n">control_start_index</span>
                            
                                    <span class="nb">print</span><span class="p">(</span><span class="n">closest_control_step</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">control_index</span> <span class="o">!=</span> <span class="n">closest_control_step</span><span class="p">:</span>
                                        <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">embed</span>
                                        <span class="n">embed</span><span class="p">()</span>
                                        <span class="n">stop</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------&quot;</span><span class="p">)</span>
                            
                                    <span class="c1"># Adding control variables is different depending on transcription, so check what type is being used</span>
                                    <span class="k">if</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;FBLT&quot;</span> <span class="ow">or</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;MGALT&quot;</span><span class="p">:</span>
                                        <span class="c1"># Add the control command to the new decision vector</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;: step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; u_x&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;: step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; u_y&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;: step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; u_z&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]])</span>
                                    <span class="k">elif</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s2">&quot;PSFB&quot;</span><span class="p">:</span>
                                        <span class="c1"># Add the state</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state r&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state RA&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state DEC&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state v&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]])</span>
                                        <span class="k">if</span> <span class="s2">&quot;AZ&quot;</span> <span class="ow">in</span> <span class="n">SM</span><span class="o">.</span><span class="n">Xdescriptions</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">MO</span><span class="o">.</span><span class="n">PSFBstateRepresentation</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state AZ&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]])</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state FPA&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]])</span>
                                        <span class="k">elif</span> <span class="s2">&quot;vRA&quot;</span> <span class="ow">in</span> <span class="n">SM</span><span class="o">.</span><span class="n">Xdescriptions</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">MO</span><span class="o">.</span><span class="n">PSFBstateRepresentation</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state vRA&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]])</span>
                                            <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state vDEC&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;I dont do psfb state conversions yet. sorry&quot;</span><span class="p">)</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: left state mass&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: virtual chemical fuel&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: virtual electric propellant&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]])</span>
                                        <span class="c1"># Add the control command to the new decision vector</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: substep0 u_x&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: substep0 u_y&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]])</span>
                                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">transcription</span> <span class="o">+</span> <span class="s2">&quot;_Step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: substep0 u_z&quot;</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">closest_control_index</span> <span class="o">+</span> <span class="mi">11</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        
                        <span class="c1"># Check if this variable is the phase flight time</span>
                        <span class="k">if</span> <span class="s2">&quot;phase flight time&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">:</span>
                            <span class="c1"># It is</span>
                            
                            <span class="c1"># Set the phase flight time</span>
                            <span class="n">phase_flight_time</span> <span class="o">=</span> <span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">dv_idx</span><span class="p">]</span>
                        
                            <span class="c1"># Get the number of timesteps</span>
                            <span class="n">sm_control_steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_flight_time</span> <span class="o">-</span> <span class="n">sm_departure_coast</span> <span class="o">-</span> <span class="n">sm_arrival_coast</span><span class="p">)</span> <span class="o">/</span> <span class="n">sm_control_timestep</span>
                        
                            <span class="c1"># Make sure we got an integer</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sm_control_steps</span><span class="p">)</span> <span class="o">-</span> <span class="n">sm_control_steps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                                 <span class="k">if</span> <span class="n">phase_flight_time</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                     <span class="c1"># This is probably okay</span>
                                     <span class="n">sm_control_steps</span> <span class="o">=</span> <span class="mi">1</span>
                                 <span class="k">else</span><span class="p">:</span>
                                     <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;sm_control steps is not an integer. Somethign went wrong finding the control timestep lengths&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sm_control_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sm_control_steps</span><span class="p">)</span>
                            
                        <span class="c1"># Check if this variable is the ep    </span>
                        <span class="k">elif</span> <span class="s2">&quot;virtual electric propellant&quot;</span> <span class="ow">in</span> <span class="n">currDVvar</span><span class="p">:</span>
                            <span class="c1"># It is</span>
                            
                            <span class="c1"># Store the ep used in this phase</span>
                            <span class="n">net_ep_used</span> <span class="o">=</span> <span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">dv_idx</span><span class="p">]</span>
                        
                        <span class="c1"># Add this variable to the decision vector</span>
                        <span class="n">new_decision_vector</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">currDVvar</span><span class="p">,</span><span class="n">SM</span><span class="o">.</span><span class="n">DecisionVector</span><span class="p">[</span><span class="n">dv_idx</span><span class="p">]])</span>
        
        <span class="n">MO</span><span class="o">.</span><span class="n">trialX</span> <span class="o">=</span> <span class="n">new_decision_vector</span>
        
        <span class="c1"># return the estination options structure with the new initial guess</span>
        <span class="k">return</span> <span class="n">MO</span></div></div>
    
    
    
    
    
    
    
    
    
    
    
        
        
        
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">EMTG python</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../PyEMTG/index.html">PyEMTG documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PEATSA/index.html">PEATSA documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptionsOverhaul/index.html">OptionsOverhaul documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2024, Jacob Englander, Donald Ellison, Jeremy Knittel, Noble Hatten.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>